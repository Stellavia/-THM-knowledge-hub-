üîó [Link to the Room](https://tryhackme.com/room/androidmalwareanalysis)

## üè∑Ô∏è **Topic:** Android malware analysis with Pithus (static and hunting). ##

# üìö Study Notes #

## First steps 

- **Android malware usually pretends to be a normal app.**
- These apps are called APKs, just like most regular Android apps.
- Sometimes malware appears on the Play Store, but that‚Äôs rare because Google removes it quickly.
- Most malicious apps come from SMS links or shady third-party websites.
- Apps from the Play Store get a special modification called **‚Äúfrosting‚Äù**.
- Frosted APK = likely from Play Store
- Not frosted APK = be suspicious (higher chance it‚Äôs malware)

- In this room, the malware is a fake (trojanized) version of the Wire chat app.
- To analyze it, we use **Pithus**, an online tool that checks APKs without running them.
- Pithus combines other tools you may already know, like MobSF, SSdeep, and APKiD.

&nbsp;

>[!NOTE]
>**Pithus** is a static analysis platform. It doesn't run the app, it just **looks inside the APK**.
>It automatically checks for too many dangerous permissions, certificates, frosting, code similarities (SSdeep) to see if the APK is similar to known malware families, checks for packers (APKiD), embedded URLs and IPs, and so on.

&nbsp;

---
><details><summary>‚ùìWhat is the name of the technique used by Google Play to mark the applications uploaded to the Google Play Store?</summary>frosting</details>
---
><details><summary>‚ùìWhat is the name of the package?</summary>com.wire</details>
---
><details><summary>‚ùìWhat is the MD5 hash of the APK?</summary>e162504122c224d4609ade9efa9af82d</details>
---
><details><summary>‚ùìWhat is the SHA256 hash of this sample?</summary>ae05bbd31820c566543addbb0ddc7b19b05be3c098d0f7aa658ab83d6f6cd5c8</details>
---
><details><summary>‚ùìWhat is the size of the smaple?</summary>40.68MB</details>
---

## Getting into the APK 
<img width="903" height="95" alt="image" src="https://github.com/user-attachments/assets/a16fb4ab-7457-4ebf-8802-ba18af452a6c" />

&nbsp;

1. **Start by identifying the APK**
  - Open the APK Analysis tab to see basic information about the app.
  - In this case, the app is trojanized (a legit app with malware added).
  - You need to find which version of the original app was targeted.
  - Quick research shows this version was released on 1 March 2021.

&nbsp;

<img width="1203" height="666" alt="image" src="https://github.com/user-attachments/assets/42996d49-e46f-4bf1-9979-c36efd2760d1" />

&nbsp;

2. **Check the timeline (Threat Intel)**
  - The Threat Intel tab shows when the malware was likely active.
  - The certificate used by the malware was created on 26 April 2021.
  - This is about 2 months after the legit app version was released.
  - This timing helps confirm when the malicious version appeared.

&nbsp;

3. **Find the main activity**
  - Back in APK Analysis, identify the app‚Äôs main activity.
  - The main activity is where the app starts running.
  - This is a very important starting point for deeper analysis.

<img width="1087" height="522" alt="image" src="https://github.com/user-attachments/assets/d56a75ba-cc8d-4bd8-a6f0-56c04fe37f04" />

&nbsp;

4. **Inspect the Manifest**
  - Look in the Manifest to see what actions the main activity can trigger as this helps you understand what the app is capable of doing.

&nbsp;

5. **Look at permissions** (Behavior Analysis)
  - Go to the Behavior Analysis tab.
  - Check the permissions the app requests.
  - The app asks for many permissions.
  - Since it‚Äôs a chat app, some (contacts, camera) make sense.
  - Still, you should always be cautious and question them.
 
&nbsp;
    
<img width="1003" height="408" alt="image" src="https://github.com/user-attachments/assets/3e8b9022-dc3b-4bfe-a769-84ff1838d7a0" />

&nbsp;

6. **Review suspicious behavior** (Threat Analysis)
  - Scroll to the Threat Analysis section.
  - This uses a tool called Quark.
  - Quark flags suspicious behaviors called ‚Äúcrimes‚Äù.
  - Multiple crimes suggest malicious intent.
    
&nbsp;
    
<img width="1076" height="449" alt="image" src="https://github.com/user-attachments/assets/4722bdf6-0ce3-4431-8f57-22ca4a3ac7c8" />

&nbsp;

7. **Identify suspicious classes**
  - Still in Behavior Analysis, look for class names linked to bad behavior.
  - These classes are important clues.
  - They tell you where to look in the code later.
    
&nbsp;

<img width="1033" height="505" alt="image" src="https://github.com/user-attachments/assets/4c670f6e-06b6-466e-9d8f-140f00a63d85" />

&nbsp;

8. **Check network activity**
  - Open the Network Analysis tab.
  - You‚Äôll see domains the app tries to contact.
  - Advanced malware often hides or obfuscates these domains.
  - Even limited clues are still useful.
    
&nbsp;

<img width="1074" height="681" alt="image" src="https://github.com/user-attachments/assets/7d5364e3-ac93-4958-bb9b-995c1c39a8f9" />

&nbsp;

---
><details><summary>‚ùìWhich version of the application is targeted?</summary>3.65.979</details>
---
><details><summary>‚ùìCheck all the activities. There is one standing out. Which one is it?</summary>org.xmlpush.v3.StartVersion</details>
---
><details><summary>‚ùìHow many activities in the Manifest analysis are linked to the activity that we hae identified?</summary>3</details>
---
><details><summary>‚ùìWhat is the first crime identified?</summary>load external class</details>
---
><details><summary>‚ùìThere is a crime that should attract your attention. It is something that shouldn't happen with a non-malicious chat app. What crime is it?</summary>Hide the current app's icon</details>
---
><details><summary>‚ùìHow many classes have a TCP connection and are identified as being part of our malicious activity?</summary>5</details>
---
><details><summary>‚ùìWhich one of the classes having a TCP connection is probably not malicous?</summary>okio/Okio.java</details>
---

&nbsp;

## Hunting 

- Hunting means **looking for other malware samples** that are the same as, or similar to, the one you‚Äôre analyzing. - This is important because it helps you understan who the victims might be, the attacker‚Äôs Tactics, Techniques, and Procedures (TTPs).

**Pithus provides several ways to hunt** for related samples:

1. **Search by similarity**
  - Go to Fingerprints tab, scroll down to the SSdeep and Dexofuzzy results.
  - Use the magnifying glass to search for similar APKs.
  - In this case, no similar samples were found.

&nbsp;

<img width="941" height="492" alt="image" src="https://github.com/user-attachments/assets/e9ce79e0-9591-4b58-a797-d2295739451e" />

&nbsp;

2. **Search by malware names**
  - Open Threat Intel, scroll down to Most Popular AV Detections.
  - Antivirus vendors sometimes give malware recognizable names, you can then search for other samples using these names.
  - Threat names can also hint at who the threat actor is.
  - Example: researching FinSpy helps understand the attacker and malware type.

&nbsp;

<img width="901" height="193" alt="image" src="https://github.com/user-attachments/assets/be995334-595b-4267-b782-c88145c872b8" />

&nbsp;

3. **Search using Yara rules**
  - Requires a registered Pithus account (GitHub login works).
  - Available under ‚ÄúMy Hunting‚Äù.
  - You can add your own Yara rules, search older samples (retroactive search) or create private or public rules

&nbsp;

<img width="445" height="62" alt="image" src="https://github.com/user-attachments/assets/c070d643-32ca-42a7-933e-0aca72fe7ae2" />

<img width="1162" height="272" alt="image" src="https://github.com/user-attachments/assets/d484a7ef-d9bf-42c0-971a-3948ddefde06" />

<img width="1037" height="737" alt="image" src="https://github.com/user-attachments/assets/e678038f-d3de-4faa-ba69-73221cfc38f6" />

&nbsp;

>[!IMPORTANT]
>Pithus only supports basic (vanilla) Yara ‚Äî no modules.

- Some Yara matches are already visible in the Threat Intelligence section.
- The rules used are public and available on [GitHub](https://github.com/DefensiveLabAgency/FinSpy-for-Android/blob/master/python/yara/FinSpy.yar).
- When writing Yara for APKs, you can limit the rule to APK files using `uint32(0) == 0x04034b50` (more useful on platforms like VirusTotal than in Pithus.)

>[!IMPORTANT]
>**Hunting helps you move from one sample to understanding a whole campaign ‚Äî who‚Äôs behind it, how they operate, and who they target.**

&nbsp;

---
><details><summary>‚ùìWhat do you notice that will identify our sample as having similarities with the other search results?</summary>org.xmlpush.v3</details>
---

&nbsp;


## Hunting 2 

- Let's look for the "search feature" that Pithus offers!
- On the home page of Pithus, there is a query field available.

<img width="1217" height="413" alt="image" src="https://github.com/user-attachments/assets/91acd1b9-de43-41e2-bf85-c7171dae1651" />

- Clicking the `?` icon brings up more information for some features described below.
- You can list all samples available in Pithus with this search: `*` (Note that not all samples will be shown at once.)
- You can combine searches and look for all files that have a rating on VirusTotal with: `*` and `vt >  0`
- Sometimes, searches will yield a low amount of results. You can expand the search with `*` ‚Äî For example: `threat_name:*finspy*`

&nbsp;

---
><details><summary>‚ùìFind the sha256 hash of our previous sample and run a query using the hash. What is the query you used?</summary>SHA256:ae05bbd31820c566543addbb0ddc7b19b05be3c098d0f7aa658ab83d6f6cd5c8</details>
---
><details><summary>‚ùìWhat query would you use to find the non malicious class that we identified previously?</summary>java_classes: "okio/Okio"</details>
---

